# PIPELINE DEFINITION
# Name: katib-pipeline
# Description: load_data_task = load_data()
#              prepare_data_task = prepare_data(data_input=load_data_task.outputs['data_output'])
# Inputs:
#    client_namespace: str [Default: 'kubeflow-user-example-com']
#    experiment_name: str
#    experiment_namespace: str [Default: 'kubeflow-user-example-com']
#    learning_rate_max: float [Default: 0.2]
#    learning_rate_min: float [Default: 0.01]
#    max_failed_trial_counts: int [Default: 3.0]
#    max_trial_counts: int [Default: 6.0]
#    n_estimators_max: int [Default: 2000.0]
#    n_estimators_min: int [Default: 1000.0]
#    parallel_trial_counts: int [Default: 1.0]
components:
  comp-create-katib-experiment-task:
    executorLabel: exec-create-katib-experiment-task
    inputDefinitions:
      parameters:
        client_namespace:
          parameterType: STRING
        experiment_name:
          parameterType: STRING
        experiment_namespace:
          parameterType: STRING
        learning_rate_max:
          parameterType: NUMBER_DOUBLE
        learning_rate_min:
          parameterType: NUMBER_DOUBLE
        max_failed_trial_counts:
          parameterType: NUMBER_INTEGER
        max_trial_counts:
          parameterType: NUMBER_INTEGER
        n_estimators_max:
          parameterType: NUMBER_INTEGER
        n_estimators_min:
          parameterType: NUMBER_INTEGER
        parallel_trial_counts:
          parameterType: NUMBER_INTEGER
deploymentSpec:
  executors:
    exec-create-katib-experiment-task:
      container:
        args:
        - --executor_input
        - '{{$}}'
        - --function_to_execute
        - create_katib_experiment_task
        command:
        - sh
        - -c
        - "\nif ! [ -x \"$(command -v pip)\" ]; then\n    python3 -m ensurepip ||\
          \ python3 -m ensurepip --user || apt-get install python3-pip\nfi\n\nPIP_DISABLE_PIP_VERSION_CHECK=1\
          \ python3 -m pip install --quiet --no-warn-script-location 'kfp==2.2.0'\
          \ '--no-deps' 'typing-extensions>=3.7.4,<5; python_version<\"3.9\"'  &&\
          \  python3 -m pip install --quiet --no-warn-script-location 'kubeflow-katib==0.17.0'\
          \ && \"$0\" \"$@\"\n"
        - sh
        - -ec
        - 'program_path=$(mktemp -d)


          printf "%s" "$0" > "$program_path/ephemeral_component.py"

          _KFP_RUNTIME=true python3 -m kfp.dsl.executor_main                         --component_module_path                         "$program_path/ephemeral_component.py"                         "$@"

          '
        - "\nimport kfp\nfrom kfp import dsl\nfrom kfp.dsl import *\nfrom typing import\
          \ *\n\ndef create_katib_experiment_task(\n    experiment_name: str, \n \
          \   experiment_namespace: str, \n    client_namespace: str, \n    max_trial_counts:\
          \ int, \n    max_failed_trial_counts: int, \n    parallel_trial_counts:\
          \ int,\n    n_estimators_min: int,\n    n_estimators_max: int,\n    learning_rate_min:\
          \ float, \n    learning_rate_max: float, \n):\n    from kubeflow.katib import\
          \ KatibClient\n    from kubernetes.client import V1ObjectMeta\n    from\
          \ kubeflow.katib import V1beta1Experiment\n    from kubeflow.katib import\
          \ V1beta1AlgorithmSpec\n    from kubeflow.katib import V1beta1ObjectiveSpec\n\
          \    from kubeflow.katib import V1beta1FeasibleSpace\n    from kubeflow.katib\
          \ import V1beta1ExperimentSpec\n    from kubeflow.katib import V1beta1ObjectiveSpec\n\
          \    from kubeflow.katib import V1beta1ParameterSpec\n    from kubeflow.katib\
          \ import V1beta1TrialTemplate\n    from kubeflow.katib import V1beta1TrialParameterSpec\n\
          \n    metadata = V1ObjectMeta(\n        name=experiment_name, \n       \
          \ namespace=experiment_namespace\n    )\n\n    algorithm_spec = V1beta1AlgorithmSpec(\n\
          \        algorithm_name=\"random\"\n    )\n\n    objective_spec = V1beta1ObjectiveSpec(\n\
          \        type=\"maximize\",\n        goal= 0.99,\n        objective_metric_name=\"\
          accuracy\",\n    )\n\n    parameters = [\n        V1beta1ParameterSpec(\n\
          \            name=\"lr\",\n            parameter_type=\"double\",\n    \
          \        feasible_space=V1beta1FeasibleSpace(\n                min=str(learning_rate_min),\n\
          \                max=str(learning_rate_max)\n            ),\n        ),\n\
          \        V1beta1ParameterSpec(\n            name=\"ne\",\n            parameter_type=\"\
          int\",\n            feasible_space=V1beta1FeasibleSpace(\n             \
          \   min=str(n_estimators_min),\n                max=str(n_estimators_max)\n\
          \            ),\n        ),\n    ]\n\n    trial_spec={\n        \"apiVersion\"\
          : \"batch/v1\",\n        \"kind\": \"Job\",\n        \"spec\": {\n     \
          \       \"template\": {\n                \"metadata\": {\n             \
          \       \"annotations\": {\n                        \"sidecar.istio.io/inject\"\
          : \"false\"\n                    }\n                },\n               \
          \ \"spec\": {\n                    \"containers\": [\n                 \
          \       {\n                            \"name\": \"training-container\"\
          ,\n                            \"image\": \"docker.io/killer66562/xgboost-trainer\"\
          ,\n                            \"command\": [\n                        \
          \        \"python3\",\n                                \"/opt/xgboost/train.py\"\
          ,\n                                \"--lr=${trialParameters.learningRate}\"\
          ,\n                                \"--ne=${trialParameters.nEstimators}\"\
          \n                            ],\n\n                            #\"volumeMounts\"\
          : [\n                            #    {\n                            # \
          \       \"name\": \"datasets\", \n                            #        \"\
          mountPath\": \"/mnt/datasets\", \n                            #    }\n \
          \                           #]\n                        }\n            \
          \        ],\n                    \"restartPolicy\": \"Never\"\n        \
          \        }\n            }\n        }\n    }\n\n    trial_template=V1beta1TrialTemplate(\n\
          \        primary_container_name=\"training-container\",\n        trial_parameters=[\n\
          \            V1beta1TrialParameterSpec(\n                name=\"learningRate\"\
          ,\n                description=\"Learning rate for the training model\"\
          ,\n                reference=\"lr\"\n            ),\n            V1beta1TrialParameterSpec(\n\
          \                name=\"nEstimators\",\n                description=\"N\
          \ estimators for the training model\",\n                reference=\"ne\"\
          \n            )\n        ],\n        trial_spec=trial_spec,\n        retain=True\n\
          \    )\n\n    experiment = V1beta1Experiment(\n        api_version=\"kubeflow.org/v1beta1\"\
          ,\n        kind=\"Experiment\",\n        metadata=metadata,\n        spec=V1beta1ExperimentSpec(\n\
          \            max_trial_count=max_trial_counts,\n            parallel_trial_count=parallel_trial_counts,\n\
          \            max_failed_trial_count=max_failed_trial_counts,\n         \
          \   algorithm=algorithm_spec,\n            objective=objective_spec,\n \
          \           parameters=parameters,\n            trial_template=trial_template,\n\
          \        )\n    )\n\n    client = KatibClient(namespace=client_namespace)\n\
          \    client.create_experiment(experiment=experiment)\n\n"
        image: python:3.10-slim
pipelineInfo:
  description: 'load_data_task = load_data()

    prepare_data_task = prepare_data(data_input=load_data_task.outputs[''data_output''])'
  name: katib-pipeline
root:
  dag:
    tasks:
      create-katib-experiment-task:
        cachingOptions:
          enableCache: true
        componentRef:
          name: comp-create-katib-experiment-task
        inputs:
          parameters:
            client_namespace:
              componentInputParameter: client_namespace
            experiment_name:
              componentInputParameter: experiment_name
            experiment_namespace:
              componentInputParameter: experiment_namespace
            learning_rate_max:
              componentInputParameter: learning_rate_max
            learning_rate_min:
              componentInputParameter: learning_rate_min
            max_failed_trial_counts:
              componentInputParameter: max_failed_trial_counts
            max_trial_counts:
              componentInputParameter: max_trial_counts
            n_estimators_max:
              componentInputParameter: n_estimators_max
            n_estimators_min:
              componentInputParameter: n_estimators_min
            parallel_trial_counts:
              componentInputParameter: parallel_trial_counts
        taskInfo:
          name: create-katib-experiment-task
  inputDefinitions:
    parameters:
      client_namespace:
        defaultValue: kubeflow-user-example-com
        isOptional: true
        parameterType: STRING
      experiment_name:
        parameterType: STRING
      experiment_namespace:
        defaultValue: kubeflow-user-example-com
        isOptional: true
        parameterType: STRING
      learning_rate_max:
        defaultValue: 0.2
        isOptional: true
        parameterType: NUMBER_DOUBLE
      learning_rate_min:
        defaultValue: 0.01
        isOptional: true
        parameterType: NUMBER_DOUBLE
      max_failed_trial_counts:
        defaultValue: 3.0
        isOptional: true
        parameterType: NUMBER_INTEGER
      max_trial_counts:
        defaultValue: 6.0
        isOptional: true
        parameterType: NUMBER_INTEGER
      n_estimators_max:
        defaultValue: 2000.0
        isOptional: true
        parameterType: NUMBER_INTEGER
      n_estimators_min:
        defaultValue: 1000.0
        isOptional: true
        parameterType: NUMBER_INTEGER
      parallel_trial_counts:
        defaultValue: 1.0
        isOptional: true
        parameterType: NUMBER_INTEGER
schemaVersion: 2.1.0
sdkVersion: kfp-2.2.0
